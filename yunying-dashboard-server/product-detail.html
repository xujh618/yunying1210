<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品详细数据</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #f0f4f8;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e7ff;
        }
        
        h1 {
            color: #2563eb;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .back-link {
            color: #2563eb;
            text-decoration: none;
            font-weight: 500;
            align-self: flex-start;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .date-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .date-selector label {
            color: #4b5563;
            font-weight: 500;
            font-size: 14px;
        }
        
        .date-selector input[type="month"] {
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 6px 10px;
            color: #333;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .date-selector input[type="month"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .date-selector button {
            background: #2563eb;
            border: none;
            border-radius: 4px;
            padding: 6px 16px;
            color: white;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .date-selector button:hover {
            background: #1d4ed8;
        }
        
        .data-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: stretch;
        }
        
        .data-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
            transition: all 0.3s ease;
            height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        /* 响应式设计 */
        @media (max-width: 900px) {
            .data-card {
                flex: 0 0 calc(50% - 7.5px);
            }
        }
        
        @media (max-width: 600px) {
            .data-card {
                flex: 0 0 100%;
            }
        }
        
        .data-card:hover {
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.15);
            transform: translateY(-3px);
            border-color: #93c5fd;
        }
        
        .data-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #2563eb;
            margin: 8px 0;
        }
        
        .data-card .label {
            color: #6b7280;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-card .internal-data {
            color: #94a3b8;
            font-size: 14px;
            margin: 5px 0;
            font-weight: 500;
        }
        
        .chart-section {
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .chart-section h2 {
            color: #2563eb;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        
        .function-section {
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .function-section h2 {
            color: #2563eb;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .function-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .function-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .function-item:hover {
            background: #eff6ff;
            border-color: #2563eb;
        }
        
        .function-item.highlight {
            border-color: #2563eb;
            background: #eff6ff;
        }
        
        .function-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        
        .function-count {
            color: #2563eb;
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .modal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .modal-stat {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 6px;
        }
        
        .modal-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2563eb;
            margin: 5px 0;
        }
        
        .modal-stat .label {
            color: #6b7280;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        /* Top and bottom functions */
        .top-bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .top-bottom {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
        }
        
        .top-bottom h3 {
            color: #2563eb;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        
        .top-bottom-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .top-bottom-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #2563eb;
        }
        
        .top-bottom-item.low {
            border-left-color: #94a3b8;
        }
        
        @media (max-width: 768px) {
            .top-bottom-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">
            ← 返回总览
        </a>
        
        <h1 id="productTitle">产品详细数据</h1>
        
        <div class="date-selector">
            <label for="start-date">开始月份：</label>
            <input type="month" id="start-date" value="2025-01">
            <label for="end-date">结束月份：</label>
            <input type="month" id="end-date" value="2025-12">
            <button onclick="filterData()">筛选</button>
        </div>
        
        <!-- 动态内容区域 -->
        <div id="dynamicContent">
            <!-- 内容将通过JavaScript动态生成 -->
        </div>
    </div>
    
    <!-- 规划报告编制工具弹窗 -->
    <div id="planningToolModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>规划报告编制工具详情</h2>
            <div class="modal-stats">
                <div class="modal-stat">
                    <div class="label">项目数</div>
                    <div class="value">156</div>
                </div>
                <div class="modal-stat">
                    <div class="label">成员数</div>
                    <div class="value">892</div>
                </div>
                <div class="modal-stat">
                    <div class="label">上传文件数量</div>
                    <div class="value">3,245</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 获取URL参数
        function getUrlParams() {
            const params = {};
            const urlParams = new URLSearchParams(window.location.search);
            for (const [key, value] of urlParams) {
                params[key] = value;
            }
            return params;
        }
        
        // 生成随机访问数据的函数
        function generateRandomVisits(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        // 从后端API获取数据
        async function getProductDataFromApi(productType, startDate = null, endDate = null) {
            try {
                // 根据产品类型映射到对应的表名
                const tableMap = {
                    'digitalThinkTankData': 'digital_library_monthly_trend',
                    'functionUsageData': 'digital_library_feature_usage',
                    'departmentVisitsData': 'digital_library_department_visits',
                    'biddingData': 'bidding_platform_monthly_trend',
                    'biddingDepartmentData': 'bidding_platform_department_visits',
                    'procurementData': 'smart_procurement_monthly_trend',
                    'procurementUserData': 'smart_procurement_monthly_users', // 添加广咨智采月度用户数据表映射
                    'materialData': 'material_price_monthly_trend',
                    'materialCoreData': 'material_price_monthly_core', // 材价库核心数据表映射
                    'materialDepartmentData': 'material_price_department_visits' // 材价库部门访问数据表映射
                };
                
                const tableName = tableMap[productType] || 'digital_library_monthly_trend';
                
                // 构建查询参数
                const params = new URLSearchParams();
                if (startDate) {
                    params.append('startDate', startDate);
                }
                if (endDate) {
                    params.append('endDate', endDate);
                }
                
                const queryString = params.toString();
                const url = queryString ? `/api/data/${tableName}?${queryString}` : `/api/data/${tableName}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    return data.data;
                } else {
                    console.error('获取数据失败:', data.message);
                    return null;
                }
            } catch (error) {
                console.error('获取数据时发生错误:', error.message);
                return null;
            }
        }
        
        // 生成数字智库配置
        async function generateDigitalThinkTankConfig(startDate = null, endDate = null) {
            // 从后端API获取数据，传递日期筛选参数
            const monthlyData = await getProductDataFromApi('digitalThinkTankData', startDate, endDate);
            
            // 默认数据
            const defaultConfig = {
                title: '数字智库 - 详细数据',
                cards: [
                    { label: '访问次数', value: '0', unit: '次' },
                    { label: '访问人数', value: '0', unit: '人' },
                    { label: '注册用户数', value: '0', unit: '人' }
                ],
                functionData: [],
                departmentData: [],
                hasData: false
            };
            
            // 无论是否有月度数据，都获取功能使用数据和部门访问数据
            try {
                // 传递日期筛选参数获取功能使用数据
                console.log('尝试获取功能使用数据...');
                const functionData = await getProductDataFromApi('functionUsageData', startDate, endDate);
                console.log('功能使用数据:', functionData);
                if (functionData && functionData.length > 0) {
                    defaultConfig.functionData = functionData;
                }
            } catch (error) {
                console.error('获取功能使用数据失败:', error);
            }
            
            try {
                // 传递日期筛选参数获取部门访问数据
                console.log('尝试获取部门访问数据...');
                const departmentData = await getProductDataFromApi('departmentVisitsData', startDate, endDate);
                console.log('部门访问数据:', departmentData);
                if (departmentData && departmentData.length > 0) {
                    // 无论是否选择了月份范围，都计算所有部门数据的总和
                    // 按部门名称分组，计算每个部门的总访问次数
                    const departmentSumMap = new Map();
                    departmentData.forEach(item => {
                        const departmentName = item.department_name;
                        const visits = parseInt(item.visits) || 0;
                        
                        if (departmentSumMap.has(departmentName)) {
                            departmentSumMap.set(departmentName, departmentSumMap.get(departmentName) + visits);
                        } else {
                            departmentSumMap.set(departmentName, visits);
                        }
                    });
                    
                    // 转换为数组格式
                    const departmentSumArray = Array.from(departmentSumMap.entries()).map(([name, visits]) => ({
                        department_name: name,
                        visits: visits
                    }));
                    
                    defaultConfig.departmentData = departmentSumArray;
                    console.log('计算后的部门总和数据:', departmentSumArray);
                }
            } catch (error) {
                console.error('获取部门访问数据失败:', error);
            }
            
            // 直接标记为有数据，因为API返回了数据
            defaultConfig.hasData = true;
            
            if (monthlyData && monthlyData.length > 0) {
                let visitsTotal = 0;
                let usersTotal = 0;
                let registersTotal = 0;
                
                // 无论是否选择了月份范围，都计算所有符合条件的数据的总和
                monthlyData.forEach(data => {
                    visitsTotal += parseInt(data.visits) || 0;
                    usersTotal += parseInt(data.users) || 0;
                    registersTotal += parseInt(data.registers) || 0;
                });
                
                // 更新卡片数据
                defaultConfig.cards = [
                    { label: '访问次数', value: visitsTotal || '0', unit: '次' },
                    { label: '访问人数', value: usersTotal || '0', unit: '人' },
                    { label: '注册用户数', value: registersTotal || '0', unit: '人' }
                ];
            } else {
                // 如果没有月度数据，但有功能或部门数据，也标记为有数据
                defaultConfig.hasData = defaultConfig.functionData.length > 0 || defaultConfig.departmentData.length > 0;
            }
            
            console.log('最终配置:', defaultConfig);
            return defaultConfig;
        }
        
        // 生成广咨电子招投标交易平台配置
        async function generateBiddingConfig(startDate = null, endDate = null) {
            // 从后端API获取数据，传递日期筛选参数
            const monthlyData = await getProductDataFromApi('biddingData', startDate, endDate);
            
            // 默认数据
            const defaultConfig = {
                title: '广咨电子招投标交易平台 - 详细数据',
                cards: [
                    { label: '访问次数', value: '0', unit: '次' },
                    { label: '访问人数', value: '0', unit: '人' },
                    { label: '项目数', value: '0', unit: '个' }
                ],
                departmentData: [],
                hasData: false
            };
            
            // 无论是否有月度数据，都获取部门访问数据
            try {
                // 传递日期筛选参数获取部门访问数据
                const departmentData = await getProductDataFromApi('biddingDepartmentData', startDate, endDate);
                if (departmentData && departmentData.length > 0) {
                    // 按部门名称分组，计算每个部门的总访问次数
                    const departmentSumMap = new Map();
                    departmentData.forEach(item => {
                        const departmentName = item.department_name;
                        const visits = parseInt(item.visits) || 0;
                        
                        if (departmentSumMap.has(departmentName)) {
                            departmentSumMap.set(departmentName, departmentSumMap.get(departmentName) + visits);
                        } else {
                            departmentSumMap.set(departmentName, visits);
                        }
                    });
                    
                    // 转换为数组格式
                    const departmentSumArray = Array.from(departmentSumMap.entries()).map(([name, visits]) => ({
                        department_name: name,
                        visits: visits
                    }));
                    
                    defaultConfig.departmentData = departmentSumArray;
                }
            } catch (error) {
                console.error('获取部门数据失败:', error);
            }
            
            // 直接标记为有数据，因为API返回了数据
            defaultConfig.hasData = true;
            
            if (monthlyData && monthlyData.length > 0) {
                let visitsTotal = 0;
                let usersTotal = 0;
                let projectsTotal = 0;
                
                // 计算所有符合条件的数据的总和
                monthlyData.forEach(data => {
                    visitsTotal += parseInt(data.visits) || 0;
                    usersTotal += parseInt(data.users) || 0;
                    projectsTotal += parseInt(data.projects) || 0;
                });
                
                // 更新卡片数据
                defaultConfig.cards = [
                    { label: '访问次数', value: visitsTotal || '0', unit: '次' },
                    { label: '访问人数', value: usersTotal || '0', unit: '人' },
                    { label: '项目数', value: projectsTotal || '0', unit: '个' }
                ];
            } else {
                // 如果没有月度数据，但有功能或部门数据，也标记为有数据
                defaultConfig.hasData = defaultConfig.departmentData.length > 0;
            }
            
            return defaultConfig;
        }
        
        // 生成广咨智采配置
        async function generateProcurementConfig(startDate = null, endDate = null) {
            // 从后端API获取数据，传递日期筛选参数
            let monthlyData = await getProductDataFromApi('procurementData', startDate, endDate);
            
            // 尝试从月度用户数据表获取更详细的数据
            let userData = await getProductDataFromApi('procurementUserData', startDate, endDate);
            
            // 如果获取到了用户数据，使用用户数据覆盖月度访问趋势数据
            try {
                // 构建查询参数，包含日期筛选
                const params = new URLSearchParams();
                if (startDate) {
                    params.append('startDate', startDate);
                }
                if (endDate) {
                    params.append('endDate', endDate);
                }
                const queryString = params.toString();
                const url = queryString ? `/api/data/smart_procurement_monthly_users?${queryString}` : `/api/data/smart_procurement_monthly_users`;
                
                // 直接调用API获取广咨智采月度用户数据，并传递日期筛选参数
                const userDataResponse = await fetch(url);
                const userDataResult = await userDataResponse.json();
                if (userDataResult.success && userDataResult.data && userDataResult.data.length > 0) {
                    userData = userDataResult.data;
                    // 如果有用户数据，优先使用用户数据
                    if (userData.length > 0) {
                        monthlyData = userData;
                    }
                }
            } catch (error) {
                console.error('获取广咨智采月度用户数据失败:', error.message);
            }
            
            // 默认数据
            const defaultConfig = {
                title: '广咨智采 - 详细数据',
                cards: [
                    { label: '个人用户数量', value: '0', unit: '人' },
                    { label: '企业用户数量', value: '0', unit: '家' },
                    { label: '订单数量', value: '0', unit: '个' },
                    { label: '服务费收入', value: '0', unit: '元' }
                ],
                // 月度数据 - 用于组合图
                monthlyData: {
                    labels: [],
                    orderQuantity: [],
                    serviceIncome: []
                },
                hasData: false
            };
            
            // 直接标记为有数据，因为API返回了数据
            defaultConfig.hasData = true;
            
            if (monthlyData && monthlyData.length > 0) {
                // 计算筛选范围内所有月份的数据总和
                let personalUsersTotal = 0;
                let enterpriseUsersTotal = 0;
                let ordersTotal = 0;
                let serviceIncomeTotal = 0;
                
                monthlyData.forEach(item => {
                    personalUsersTotal += parseInt(item.personal_users || item.total_users || 0);
                    enterpriseUsersTotal += parseInt(item.enterprise_users || item.companies || 0);
                    ordersTotal += parseInt(item.orders || item.order_count || 0);
                    serviceIncomeTotal += parseInt(item.service_income || item.service_fee || 0);
                });
                
                // 更新卡片数据，显示总和
                defaultConfig.cards = [
                    { label: '个人用户数量', value: personalUsersTotal || '0', unit: '人' },
                    { label: '企业用户数量', value: enterpriseUsersTotal || '0', unit: '家' },
                    { label: '订单数量', value: ordersTotal || '0', unit: '个' },
                    { label: '服务费收入', value: serviceIncomeTotal || '0', unit: '元' }
                ];
                
                // 更新月度数据
                const labels = monthlyData.map(item => item.month);
                const orderQuantity = monthlyData.map(item => item.orders || item.order_count || 0);
                const serviceIncome = monthlyData.map(item => item.service_income || item.service_fee || 0);
                
                defaultConfig.monthlyData = {
                    labels,
                    orderQuantity,
                    serviceIncome
                };
            }
            
            return defaultConfig;
        }
        
        // 生成材价库配置
        async function generateMaterialConfig(startDate = null, endDate = null) {
            // 默认数据
            const defaultConfig = {
                title: '材价库 - 详细数据',
                cards: [
                    { label: '访问次数', value: '0', unit: '次' },
                    { label: '访问人数', value: '0', unit: '人' },
                    { label: '材价数量', value: '0', unit: '条' },
                    { label: '标准工料机数量', value: '0', unit: '条' },
                    { label: '询价申请数据', value: '0', unit: '条' },
                    { label: '询价材料数据', value: '0', unit: '条' },
                    { label: '供应商数量', value: '0', unit: '家' }
                ],
                departmentData: [],
                // 月度数据 - 用于折线图
                monthlyData: {
                    labels: [],
                    factoryQuotes: [],
                    marketInquiry: [],
                    informationPrice: []
                },
                hasData: false
            };
            
            // 从后端API获取数据，传递日期筛选参数 - 添加错误处理
            let monthlyTrendData = [];
            let coreData = [];
            let departmentData = [];
            let monthlyPriceData = [];
            
            try {
                monthlyTrendData = await getProductDataFromApi('materialData', startDate, endDate) || [];
            } catch (error) {
                console.error('获取月度趋势数据失败:', error);
            }
            
            try {
                coreData = await getProductDataFromApi('materialCoreData', startDate, endDate) || [];
            } catch (error) {
                console.error('获取核心数据失败:', error);
            }
            
            try {
                departmentData = await getProductDataFromApi('materialDepartmentData', startDate, endDate) || [];
                if (departmentData && departmentData.length > 0) {
                    defaultConfig.departmentData = departmentData;
                }
            } catch (error) {
                console.error('获取部门数据失败:', error);
            }
            
            try {
                // 从新创建的月度数据表获取数据
                const url = `/api/data/material_price_monthly_data${startDate || endDate ? '?' : ''}${startDate ? `startDate=${startDate}` : ''}${startDate && endDate ? '&' : ''}${endDate ? `endDate=${endDate}` : ''}`;
                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    monthlyPriceData = result.data || [];
                }
            } catch (error) {
                console.error('获取月度价格数据失败:', error);
            }
            
            // 直接标记为有数据，因为API返回了数据
            defaultConfig.hasData = true;
            
            // 合并月度趋势数据和核心数据
            let mergedData = [];
            if (monthlyTrendData && monthlyTrendData.length > 0) {
                // 创建月度趋势数据的映射
                const trendMap = new Map(monthlyTrendData.map(item => [item.month, item]));
                
                // 合并数据
                monthlyTrendData.forEach(item => {
                    const coreItem = coreData?.find(c => c.month === item.month) || {};
                    mergedData.push({ ...item, ...coreItem });
                });
                
                // 计算所选范围内的总和
                let totalVisits = 0;
                let totalUsers = 0;
                let totalMaterialCount = 0;
                let totalStandardItems = 0;
                let totalInquiryCount = 0;
                let totalInquiryMaterials = 0;
                let totalSupplierCount = 0;
                
                mergedData.forEach(item => {
                    totalVisits += parseInt(item.visits || 0);
                    totalUsers += parseInt(item.users || 0);
                    totalMaterialCount += parseInt(item.material_count || 0);
                    totalStandardItems += parseInt(item.standard_items || 0);
                    totalInquiryCount += parseInt(item.inquiry_count || 0);
                    totalInquiryMaterials += parseInt(item.inquiry_materials || 0);
                    totalSupplierCount += parseInt(item.supplier_count || 0);
                });
                
                // 更新卡片数据 - 使用总和数据
                defaultConfig.cards = [
                    { label: '访问次数', value: totalVisits || '0', unit: '次' },
                    { label: '访问人数', value: totalUsers || '0', unit: '人' },
                    { label: '材价数量', value: totalMaterialCount || '0', unit: '条' },
                    { label: '标准工料机数量', value: totalStandardItems || '0', unit: '条' },
                    { label: '询价申请数据', value: totalInquiryCount || '0', unit: '条' },
                    { label: '询价材料数据', value: totalInquiryMaterials || '0', unit: '条' },
                    { label: '供应商数量', value: totalSupplierCount || '0', unit: '家' }
                ];
                
                // 更新月度数据（用于折线图）
                // 如果有月度价格数据，优先使用月度价格数据
                if (monthlyPriceData && monthlyPriceData.length > 0) {
                    // 按月份升序排序
                    const sortedPriceData = [...monthlyPriceData].sort((a, b) => a.month.localeCompare(b.month));
                    
                    // 提取月度数据
                    const labels = sortedPriceData.map(item => item.month);
                    const factoryQuotes = sortedPriceData.map(item => item.factory_quotes || 0);
                    const marketInquiry = sortedPriceData.map(item => item.market_inquiries || 0);
                    const informationPrice = sortedPriceData.map(item => item.information_prices || 0);
                    
                    defaultConfig.monthlyData = {
                        labels,
                        factoryQuotes,
                        marketInquiry,
                        informationPrice
                    };
                } else {
                    // 否则使用合并的数据
                    // 按月份升序排序
                    const sortedData = [...mergedData].sort((a, b) => a.month.localeCompare(b.month));
                    
                    // 提取月度数据
                    const labels = sortedData.map(item => item.month);
                    // 注意：这里假设月度数据来自mergedData中的特定字段，如果这些字段不存在，需要根据实际情况调整
                    const factoryQuotes = sortedData.map(item => item.factory_quotes || 0);
                    const marketInquiry = sortedData.map(item => item.market_inquiries || 0);
                    const informationPrice = sortedData.map(item => item.information_prices || 0);
                    
                    defaultConfig.monthlyData = {
                        labels,
                        factoryQuotes,
                        marketInquiry,
                        informationPrice
                    };
                }
            }
            
            return defaultConfig;
        }
        
        // 产品配置数据
        let productConfig = null;
        
        // 获取当前产品
        const params = getUrlParams();
        const currentProduct = params.product || '数字智库';
        
        // 异步加载产品配置
        async function loadProductConfig() {
            // 根据产品类型调用相应的生成函数
            let config;
            if (currentProduct === '数字智库') {
                config = await generateDigitalThinkTankConfig();
            } else if (currentProduct === '广咨电子招投标交易平台') {
                config = await generateBiddingConfig();
            } else if (currentProduct === '广咨智采') {
                config = await generateProcurementConfig();
            } else if (currentProduct === '材价库') {
                config = await generateMaterialConfig();
            }
            
            productConfig = config;
            
            // 设置页面标题
            document.title = config.title;
            document.getElementById('productTitle').textContent = config.title;
            
            // 渲染内容
            renderContent(startDate, endDate);
            
            // 初始化日期选择器
            await initDateSelector();
        }
        
        // 渲染数据卡片
        function renderDataCards() {
            // 检查是否有数据
            if (!productConfig.hasData) {
                return `
                    <div style="text-align: center; padding: 40px; background: white; border-radius: 8px; margin-bottom: 30px;">
                        <h2 style="color: #94a3b8; font-weight: normal;">没有数据</h2>
                    </div>
                `;
            }
            
            const cardsHTML = productConfig.cards.map(card => {
                // 将card.value转换为字符串，防止includes方法报错
                const cardValue = String(card.value);
                
                // 检查是否包含内部数据
                const hasInternalData = cardValue.includes('（内部');
                
                if (hasInternalData) {
                    // 分离总数据和内部数据
                    const [totalData, internalData] = cardValue.split('（');
                    const cleanInternalData = internalData.replace('）', '');
                    
                    return `
                        <div class="data-card">
                            <div class="label">${card.label}</div>
                            <div class="value">${totalData}</div>
                            <div class="internal-data">${cleanInternalData}</div>
                            <div class="label">${card.unit}</div>
                        </div>
                    `;
                } else {
                    // 普通卡片
                    return `
                        <div class="data-card">
                            <div class="label">${card.label}</div>
                            <div class="value">${cardValue}</div>
                            <div class="label">${card.unit}</div>
                        </div>
                    `;
                }
            }).join('');
            
            return `<div class="data-cards">${cardsHTML}</div>`;
        }
        
        // 渲染部门访问次数条形图
        function renderDepartmentChart(startDate = null, endDate = null) {
            // 检查是否有部门数据
            console.log('渲染部门图表 - 部门数据:', productConfig.departmentData);
            console.log('渲染部门图表 - 日期范围:', startDate, '至', endDate);
            
            if (!productConfig.departmentData || productConfig.departmentData.length === 0) {
                console.log('没有部门数据，不渲染部门图表');
                return '';
            }
            
            // 检查部门数据的格式
            console.log('部门数据第一个元素:', productConfig.departmentData[0]);
            
            // 转换数据格式，确保符合图表要求
            let departmentData = productConfig.departmentData;
            
            // 处理材价库的部门数据
            if (currentProduct === '材价库' && productConfig.departmentData[0] && productConfig.departmentData[0].month && !productConfig.departmentData[0].department_name) {
                console.log('检测到材价库旧的列存储格式部门数据，需要转换');
                
                // 部门名称映射表
                const deptNameMap = {
                    'da_shu_ju_zhong_xin': '大数据中心',
                    'shu_zi_zao_jia_yi_bu': '数字造价一部',
                    'zao_jia_guan_li_san_bu': '造价管理三部',
                    'zao_jia_yi_bu': '造价一部',
                    'xin_xi_hua_guan_li_bu': '信息化管理部',
                    'zao_jia_er_bu': '造价二部',
                    'zao_jia_san_bu': '造价三部',
                    'tou_zi_zao_jia_zong_he_guan_li_bu': '投资造价综合管理部',
                    'ji_tuan_ling_dao': '集团领导',
                    'zao_jia_zi_xun_er_bu': '造价咨询二部',
                    'zao_jia_zi_xun_yi_bu': '造价咨询一部',
                    'gui_dao_jiao_tong_bu': '轨道交通部',
                    'zao_jia_guan_li_yi_bu': '造价管理一部',
                    'zao_jia_si_bu': '造价四部',
                    'dong_guan_tou_zi_ping_shen_bu': '东莞投资评审部',
                    'xiang_mu_guan_li_bu': '项目管理部',
                    'ping_shen_yi_shi': '评审一室',
                    'shu_zi_zao_jia_er_bu': '数字造价二部',
                    'feng_xian_ping_gu_zhong_xin': '风险评估中心',
                    'zi_xun_yi_bu': '咨询一部',
                    'zao_jia_wu_bu': '造价五部',
                    'zi_xun_jiu_bu': '咨询九部',
                    'dong_guan_tou_zi_zi_xun_bu': '东莞投资咨询部',
                    'cai_gou_zi_xun_si_bu': '采购咨询四部',
                    'shu_zi_zao_jia_san_bu_shu_zi_zao_jia_ji_shu_zhong_xin': '数字造价三部（数字造价技术中心）',
                    'ping_shen_er_shi': '评审二室',
                    'cai_gou_zi_xun_er_bu': '采购咨询二部',
                    'zi_xun_shi_bu_zheng_qi_he_zuo_zhong_xin': '咨询十部（政企合作中心）',
                    'zi_xun_san_bu_jiao_yu_zi_xun_bu': '咨询三部（教育咨询部）',
                    'zi_xun_wu_bu': '咨询五部',
                    'zheng_fu_cai_gou_yi_bu': '政府采购一部',
                    'di_tan_neng_yuan_zhong_xin': '低碳能源中心',
                    'zong_gong_ban_chuang_xin_guan_li_bu': '总工办（创新管理部）',
                    'cai_wu_bu': '财务部',
                    'shen_zhen_zao_jia_zi_xun_bu': '深圳造价咨询部',
                    'gong_cheng_guan_li_shi_ye_bu_ling_dao': '工程管理事业部领导',
                    'hai_nan_zao_jia_zi_xun_bu': '海南造价咨询部',
                    'shen_ji_zi_xun_bu': '审计咨询部',
                    'gui_hua_zi_xun_er_bu_zi_xun_si_bu': '规划咨询二部（咨询四部）',
                    'ji_jian_tou_zi_ping_shen_bu_ji_xiao_ping_jia_zhong_xin': '基建投资评审部（绩效评价中心）',
                    'cai_gou_zi_xun_liu_bu': '采购咨询六部',
                    'ban_gong_shi': '办公室',
                    'gui_hua_zi_xun_san_bu': '规划咨询三部',
                    'zheng_fu_cai_gou_san_bu': '政府采购三部',
                    'zi_xun_ba_bu': '咨询八部',
                    'gui_hua_fa_zhan_bu_zi_ben_yun_ying_bu': '规划发展部（资本运营部）',
                    'da_jian_kang_zi_xun_bu': '大健康咨询部',
                    'cai_gou_zi_xun_yi_bu': '采购咨询一部',
                    'shen_zhen_xiang_mu_guan_li_bu': '深圳项目管理部',
                    'tou_zi_zao_jia_shi_ye_bu_ling_dao': '投资造价事业部领导',
                    'jing_ying_ji_he_tong_guan_li_bu': '经营及合同管理部',
                    'shu_zi_hua_cai_gou_bu': '数字化采购部',
                    'yue_dong_gong_zuo_zu': '粤东工作组',
                    'hui_zhou_fen_gong_si': '惠州分公司',
                    'zi_xun_liu_bu': '咨询六部',
                    'zi_xun_ce_hua_bu': '咨询策划部',
                    'ren_li_zi_yuan_bu': '人力资源部',
                    'chan_ye_zhao_shang_zi_xun_bu': '产业招商咨询部',
                    'zheng_ce_yan_jiu_shi': '政策研究室',
                    'zheng_fu_cai_gou_si_bu_zheng_fu_cai_gou_guan_li_yan_jiu_zhong_xin': '政府采购四部（政府采购管理研究中心）',
                    'shen_zhen_tou_zi_zi_xun_bu': '深圳投资咨询部',
                    'gong_cheng_guan_li_zong_gong_shi': '工程管理总工室',
                    'gui_hua_zi_xun_yi_bu': '规划咨询一部',
                    'cai_gou_zi_xun_ba_bu_cai_gou_zi_xun_yan_jiu_zhong_xin_ban_gong_shi': '采购咨询八部（采购咨询研究中心办公室）',
                    'shen_zhen_zi_gong_si_ling_dao': '深圳子公司领导'
                };
                
                // 根据日期范围筛选数据
                let filteredData = departmentData;
                if (startDate || endDate) {
                    filteredData = departmentData.filter(item => {
                        const itemMonth = item.month;
                        const afterStart = !startDate || itemMonth >= startDate;
                        const beforeEnd = !endDate || itemMonth <= endDate;
                        return afterStart && beforeEnd;
                    });
                    console.log('根据日期范围筛选后的数据:', filteredData.length, '条');
                }
                
                // 聚合部门访问次数
                const departmentSumMap = new Map();
                
                for (const dataItem of filteredData) {
                    for (const [key, value] of Object.entries(dataItem)) {
                        // 跳过系统字段
                        if (key !== 'month' && key !== 'id' && key !== 'created_at' && key !== 'updated_at') {
                            const deptName = deptNameMap[key] || key;
                            const visits = parseInt(value) || 0;
                            
                            if (departmentSumMap.has(deptName)) {
                                departmentSumMap.set(deptName, departmentSumMap.get(deptName) + visits);
                            } else {
                                departmentSumMap.set(deptName, visits);
                            }
                        }
                    }
                }
                
                // 转换为行存储格式
                const convertedData = [];
                for (const [name, visits] of departmentSumMap.entries()) {
                    convertedData.push({
                        name: name,
                        visits: visits
                    });
                }
                
                departmentData = convertedData;
                console.log('转换后的部门数据:', departmentData);
            }
            // 如果部门数据是行存储格式，转换为前端需要的格式
            else if (departmentData[0].department_name) {
                console.log('检测到行存储格式的部门数据，需要转换');
                
                // 检查是否有month字段
                const hasMonthField = 'month' in departmentData[0];
                
                if (hasMonthField) {
                    // 筛选符合日期范围的数据
                    let filteredData = departmentData;
                    if (startDate || endDate) {
                        filteredData = departmentData.filter(item => {
                            const itemMonth = item.month;
                            const afterStart = !startDate || itemMonth >= startDate;
                            const beforeEnd = !endDate || itemMonth <= endDate;
                            return afterStart && beforeEnd;
                        });
                        console.log('根据日期范围筛选后的数据:', filteredData.length, '条');
                    }
                    
                    // 按部门名称分组，聚合访问次数
                    const departmentSumMap = new Map();
                    filteredData.forEach(item => {
                        if (departmentSumMap.has(item.department_name)) {
                            departmentSumMap.set(item.department_name, departmentSumMap.get(item.department_name) + (parseInt(item.visits) || 0));
                        } else {
                            departmentSumMap.set(item.department_name, parseInt(item.visits) || 0);
                        }
                    });
                    
                    // 转换为数组
                    departmentData = Array.from(departmentSumMap.entries()).map(([name, visits]) => ({
                        name: name,
                        visits: visits
                    }));
                } else {
                    // 如果没有month字段，说明已经是总和数据，直接转换格式
                    departmentData = departmentData.map(item => ({
                        name: item.department_name,
                        visits: item.visits
                    }));
                }
                
                console.log('转换后的部门数据:', departmentData);
            }
            
            // 按访问次数从高到低排序，确保visits有值
            const sortedDepartments = [...departmentData].sort((a, b) => (b.visits || 0) - (a.visits || 0));
            
            // 生成唯一的canvas ID
            const canvasId = 'departmentChart';
            
            const chartHTML = `
                <div class="chart-section">
                    <h2>各部门使用情况</h2>
                    <div class="chart-container" style="height: 600px; overflow-y: auto;">
                        <div style="height: auto; width: 100%; min-height: 100%;">
                            <canvas id="${canvasId}" style="height: ${departmentData.length * 30}px;"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // 延迟执行图表初始化，确保DOM已渲染
            setTimeout(() => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedDepartments.map(d => d.name),
                        datasets: [{
                            label: '访问次数',
                            data: sortedDepartments.map(d => d.visits || 0),
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', // 水平条形图
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#2563eb',
                                bodyColor: '#333',
                                borderColor: 'rgba(37, 99, 235, 0.3)',
                                borderWidth: 1,
                                padding: 10,
                                borderRadius: 4,
                                boxShadow: '0 2px 6px rgba(0, 0, 0, 0.1)'
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#6b7280',
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#6b7280',
                                    font: {
                                        size: 9
                                    },
                                    maxTicksLimit: 100
                                },
                                grid: {
                                    display: false
                                },
                                min: 0,
                                max: null,
                                ticksStepSize: 1
                            }
                        }
                    }
                });
            }, 100);
            
            return chartHTML;
        }
        
        // 渲染组合图（柱状+折线）
        function renderCombinationChart() {
            // 检查是否有月度数据
            if (!productConfig.monthlyData || productConfig.monthlyData.labels.length === 0) {
                return '';
            }
            
            // 确保数据数组存在且有值
            const serviceIncome = productConfig.monthlyData.serviceIncome || [];
            const orderQuantity = productConfig.monthlyData.orderQuantity || [];
            
            // 生成唯一的canvas ID
            const canvasId = 'combinationChart';
            
            const chartHTML = `
                <div class="chart-section">
                    <h2>月度订单数量与服务费收入</h2>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="${canvasId}"></canvas>
                    </div>
                </div>
            `;
            
            // 延迟执行图表初始化，确保DOM已渲染
            setTimeout(() => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: productConfig.monthlyData.labels,
                        datasets: [
                            {
                                label: '服务费收入（元）',
                                data: serviceIncome.map(value => value || 0),
                                type: 'bar',
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: '订单数量（个）',
                                data: orderQuantity.map(value => value || 0),
                                type: 'line',
                                backgroundColor: 'rgba(249, 115, 22, 0.7)',
                                borderColor: 'rgba(249, 115, 22, 1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#2563eb',
                                bodyColor: '#333',
                                borderColor: 'rgba(37, 99, 235, 0.3)',
                                borderWidth: 1,
                                padding: 10,
                                borderRadius: 4,
                                boxShadow: '0 2px 6px rgba(0, 0, 0, 0.1)'
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '服务费收入（元）',
                                    color: '#6b7280'
                                },
                                ticks: {
                                    color: '#6b7280',
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '订单数量（个）',
                                    color: '#6b7280'
                                },
                                ticks: {
                                    color: '#6b7280'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#6b7280'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            }, 100);
            
            return chartHTML;
        }
        
        // 渲染折线图（材价库月度数据）
        function renderLineChart() {
            // 检查是否有月度数据
            if (!productConfig.monthlyData || productConfig.monthlyData.labels.length === 0) {
                return '';
            }
            
            // 确保数据数组存在且有值
            const factoryQuotes = productConfig.monthlyData.factoryQuotes || [];
            const marketInquiry = productConfig.monthlyData.marketInquiry || [];
            const informationPrice = productConfig.monthlyData.informationPrice || [];
            
            // 生成唯一的canvas ID
            const canvasId = 'lineChart';
            
            const chartHTML = `
                <div class="chart-section">
                    <h2>月度厂商报价、市场询价、信息价</h2>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="${canvasId}"></canvas>
                    </div>
                </div>
            `;
            
            // 延迟执行图表初始化，确保DOM已渲染
            setTimeout(() => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: productConfig.monthlyData.labels,
                        datasets: [
                            {
                                label: '厂商报价',
                                data: factoryQuotes.map(value => value || 0),
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: '市场询价',
                                data: marketInquiry.map(value => value || 0),
                                backgroundColor: 'rgba(249, 115, 22, 0.7)',
                                borderColor: 'rgba(249, 115, 22, 1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: '信息价',
                                data: informationPrice.map(value => value || 0),
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#2563eb',
                                bodyColor: '#333',
                                borderColor: 'rgba(37, 99, 235, 0.3)',
                                borderWidth: 1,
                                padding: 10,
                                borderRadius: 4,
                                boxShadow: '0 2px 6px rgba(0, 0, 0, 0.1)'
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                title: {
                                    display: true,
                                    text: '数量',
                                    color: '#6b7280'
                                },
                                ticks: {
                                    color: '#6b7280',
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#6b7280'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            }, 100);
            
            return chartHTML;
        }
        
        // 生成功能项列表（仅数字智库）
        function renderFunctionItems() {
            console.log('渲染功能项 - 功能数据:', productConfig.functionData);
            
            if (!productConfig.functionData || productConfig.functionData.length === 0) {
                console.log('没有功能数据，不渲染功能项');
                return '';
            }
            
            let functionData = productConfig.functionData;
            
            // 检查功能数据的格式
            console.log('功能数据第一个元素:', functionData[0]);
            
            // 转换功能数据格式：从列存储转换为行存储
            let transformedFunctionData = [];
            
            // 如果功能数据是列存储格式（每条记录包含多个功能列）
            if (functionData[0].homepage_visits !== undefined) {
                console.log('检测到列存储格式的功能数据，需要转换');
                
                // 定义功能名称映射关系
                const featureMap = {
                    'search_visits': '搜索访问',
                    'stats_yearbook': '统计年鉴',
                    'stats_bulletin': '统计公报',
                    'macro_charts': '宏观图表',
                    'indicator_query': '指标查询',
                    'industry_data': '行业数据',
                    'policy_materials': '政策资料',
                    'government_bulletin': '政府公报',
                    'engineering_specs': '工程规范',
                    'regional_news': '区域新闻',
                    'current_affairs': '时事动态',
                    'project_results': '项目成果',
                    'potential_reits': '潜在REITS',
                    'investment_cases': '投资案例',
                    'planning_tool': '规划报告编制工具',
                    'knowledge_graph_medical': '医疗知识图谱',
                    'calculator': '计算器',
                    'rural_revitalization': '乡村振兴',
                    'policy_visualization': '政策可视化',
                    'personal_center': '个人中心'
                };
                
                // 初始化功能数据总和对象
                const featureSumMap = new Map();
                for (const [key, name] of Object.entries(featureMap)) {
                    featureSumMap.set(name, 0);
                }
                
                // 遍历所有月份数据，计算总和
                functionData.forEach(data => {
                    for (const [key, name] of Object.entries(featureMap)) {
                        // 即使值是null，也转换为0处理
                        featureSumMap.set(name, featureSumMap.get(name) + (parseInt(data[key]) || 0));
                    }
                });
                
                // 转换为行存储格式
                for (const [name, usage] of featureSumMap.entries()) {
                    transformedFunctionData.push({
                        name: name,
                        usage: usage
                    });
                }
                
                console.log('转换后的功能数据:', transformedFunctionData);
            } 
            // 如果功能数据是行存储格式（每条记录有feature_name和usage字段）
            else if (functionData[0].feature_name) {
                console.log('检测到行存储格式的功能数据，需要转换');
                // 按功能名称分组，取每个功能的最新数据
                const featureMap = new Map();
                functionData.forEach(item => {
                    if (!featureMap.has(item.feature_name) || 
                        (featureMap.get(item.feature_name).month < item.month)) {
                        featureMap.set(item.feature_name, item);
                    }
                });
                
                // 转换为数组
                transformedFunctionData = Array.from(featureMap.values()).map(item => ({
                    name: item.feature_name,
                    usage: item.usage
                }));
                
                console.log('转换后的功能数据:', transformedFunctionData);
            } else {
                // 如果已经是前端需要的格式，直接使用
                transformedFunctionData = functionData;
            }
            
            // 使用转换后的数据
            functionData = transformedFunctionData;
            
            // 生成功能项
            const functionStats = functionData.map(item => {
                const isHighlight = item.name === '规划报告编制工具';
                const highlightClass = isHighlight ? ' highlight' : '';
                const onClick = isHighlight ? ' onclick="openModal()"' : '';
                // 确保usage有值，默认为0
                const usage = item.usage || 0;
                
                return `
                    <div class="function-item${highlightClass}"${onClick}>
                        <span class="function-name">${item.name}</span>
                        <span class="function-count">${usage.toLocaleString()}</span>
                    </div>
                `;
            }).join('');
            
            // 按使用次数排序，确保usage有值
            const sortedData = [...functionData].sort((a, b) => (b.usage || 0) - (a.usage || 0));
            const top3 = sortedData.slice(0, 3);
            const bottom3 = sortedData.slice(-3).reverse();
            
            // 生成TOP 3
            const topFunctions = top3.map(item => {
                const usage = item.usage || 0;
                return `
                    <div class="top-bottom-item">
                        <span>${item.name}</span>
                        <span>${usage.toLocaleString()}</span>
                    </div>
                `;
            }).join('');
            
            // 生成BOTTOM 3
            const bottomFunctions = bottom3.map(item => {
                const usage = item.usage || 0;
                return `
                    <div class="top-bottom-item low">
                        <span>${item.name}</span>
                        <span>${usage.toLocaleString()}</span>
                    </div>
                `;
            }).join('');
            
            // 生成功能板块使用次数柱状图（仅保留使用次数）
            const functionChartId = 'functionUsageChart';
            
            setTimeout(() => {
                const ctx = document.getElementById(functionChartId).getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: functionData.map(f => f.name),
                        datasets: [{
                            label: '使用次数',
                            data: functionData.map(f => f.usage || 0),
                            backgroundColor: 'rgba(37, 99, 235, 0.7)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#2563eb',
                                bodyColor: '#333',
                                borderColor: 'rgba(37, 99, 235, 0.3)',
                                borderWidth: 1,
                                padding: 10,
                                borderRadius: 4,
                                boxShadow: '0 2px 6px rgba(0, 0, 0, 0.1)'
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#6b7280',
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#6b7280',
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }, 100);
            
            return `
                <div class="chart-section">
                    <h2>功能板块使用次数 <span style="color: #94a3b8; font-size: 0.8em; font-weight: normal;">（已剔除大数据中心数据）</span></h2>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="${functionChartId}"></canvas>
                    </div>
                </div>
                
                <div class="function-section">
                    <h2>功能板块使用数据</h2>
                    
                    <div class="top-bottom-section">
                        <div class="top-bottom">
                            <h3>使用次数TOP 3</h3>
                            <div class="top-bottom-list">
                                ${topFunctions}
                            </div>
                        </div>
                        <div class="top-bottom">
                            <h3>使用次数BOTTOM 3</h3>
                            <div class="top-bottom-list">
                                ${bottomFunctions}
                            </div>
                        </div>
                    </div>
                    
                    <div class="function-stats" style="margin-top: 30px;">
                        ${functionStats}
                    </div>
                </div>
            `;
        }
        
        // 渲染完整内容
        function renderContent(startDate = null, endDate = null) {
            let content = '';
            
            // 渲染数据卡片
            content += renderDataCards();
            
            // 根据产品类型渲染不同的图表
            if (currentProduct === '广咨智采') {
                // 广咨智采 - 渲染组合图
                content += renderCombinationChart();
            } else if (currentProduct === '材价库') {
                // 材价库 - 先渲染部门图表，再渲染折线图
                if (productConfig.departmentData) {
                    content += renderDepartmentChart(startDate, endDate);
                }
                if (productConfig.monthlyData) {
                    content += renderLineChart();
                }
            } else if (productConfig.departmentData) {
                // 其他产品 - 渲染部门图表
                content += renderDepartmentChart(startDate, endDate);
            }
            
            // 渲染功能项（如果有）
            content += renderFunctionItems();
            
            document.getElementById('dynamicContent').innerHTML = content;
        }
        
        // 日期筛选功能
        async function filterData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            console.log('筛选数据:', startDate, '至', endDate);
            
            // 重新加载产品配置，应用筛选条件
            await loadProductConfig(startDate, endDate);
        }
        
        // 异步加载产品配置（支持日期筛选）
        async function loadProductConfig(startDate = null, endDate = null) {
            // 根据产品类型调用相应的生成函数
            let config;
            if (currentProduct === '数字智库') {
                config = await generateDigitalThinkTankConfig(startDate, endDate);
            } else if (currentProduct === '广咨电子招投标交易平台') {
                config = await generateBiddingConfig(startDate, endDate);
            } else if (currentProduct === '广咨智采') {
                config = await generateProcurementConfig(startDate, endDate);
            } else if (currentProduct === '材价库') {
                config = await generateMaterialConfig(startDate, endDate);
            }
            
            productConfig = config;
            
            // 设置页面标题
            document.title = config.title;
            document.getElementById('productTitle').textContent = config.title;
            
            // 渲染内容
            renderContent();
        }
        
        // 弹窗功能
        const modal = document.getElementById('planningToolModal');
        
        async function openModal() {
            modal.style.display = 'block';
            
            try {
                // 从API获取规划报告编制工具详情数据
                const response = await fetch('/api/data/digital_library_planning_tool_details');
                const result = await response.json();
                
                const planningToolDetails = result.success && result.data.length > 0 ? result.data[0] : {};
                
                // 更新模态框内容
                const projectValue = document.querySelector('#planningToolModal .modal-stat:nth-child(1) .value');
                const memberValue = document.querySelector('#planningToolModal .modal-stat:nth-child(2) .value');
                const fileValue = document.querySelector('#planningToolModal .modal-stat:nth-child(3) .value');
                
                if (projectValue) {
                    projectValue.textContent = (planningToolDetails.projects || 0).toLocaleString();
                }
                if (memberValue) {
                    memberValue.textContent = (planningToolDetails.members || 0).toLocaleString();
                }
                if (fileValue) {
                    fileValue.textContent = (planningToolDetails.files || 0).toLocaleString();
                }
            } catch (error) {
                console.error('获取规划报告编制工具详情数据失败:', error);
            }
        }
        
        function closeModal() {
            modal.style.display = 'none';
        }
        
        // 点击弹窗外部关闭弹窗
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // 初始化日期选择器
        async function initDateSelector() {
            try {
                // 获取当前产品类型对应的表名
                let tableName;
                switch(currentProduct) {
                    case '数字智库':
                        tableName = 'digital_library_monthly_trend';
                        break;
                    case '广咨电子招投标交易平台':
                        tableName = 'digital_library_monthly_trend';
                        break;
                    case '广咨智采':
                        tableName = 'smart_procurement_monthly_trend';
                        break;
                    case '材价库':
                        tableName = 'material_price_monthly_trend';
                        break;
                    default:
                        tableName = 'digital_library_monthly_trend';
                }
                
                // 从API获取所有数据，提取可用月份
                const response = await fetch(`/api/data/${tableName}`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const monthlyData = result.data;
                    const availableMonths = monthlyData.map(item => item.month);
                    
                    // 设置日期选择器的最小值和最大值
                    const startDateInput = document.getElementById('start-date');
                    const endDateInput = document.getElementById('end-date');
                    
                    if (availableMonths.length > 0) {
                        // 月份格式已经是 "2025-01"，直接使用
                        const minMonth = availableMonths.sort()[0];
                        const maxMonth = availableMonths.sort().reverse()[0];
                        
                        startDateInput.min = minMonth;
                        endDateInput.min = minMonth;
                        startDateInput.max = maxMonth;
                        endDateInput.max = maxMonth;
                        
                        // 设置默认值为最新月份
                        startDateInput.value = minMonth;
                        endDateInput.value = maxMonth;
                    }
                }
            } catch (error) {
                console.error('初始化日期选择器失败:', error);
            }
        }
        
        // 初始化页面
        loadProductConfig();
    </script>
</body>
</html>